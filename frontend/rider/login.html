<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Login - QuickDash</title>
    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <style>
        body { background-color: #111; color: #fff; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .login-card { background: #222; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; }
        .form-control { background: #333; border: 1px solid #444; color: #fff; margin-bottom: 15px; }
        .btn-primary { background: #32CD32; border: none; width: 100%; padding: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="login-card">
        <h2 style="color: #32CD32;"><i class="fas fa-biking"></i> Rider App</h2>
        <p class="text-muted mb-4">Login to start delivering</p>

        <form id="rider-login-form">
            <input type="tel" id="phone" class="form-control" placeholder="Phone Number (e.g. 9999999999)" required>
            <input type="text" id="otp" class="form-control" placeholder="Enter OTP (Any 6 digits for dev)" style="display:none;" required>
            <button type="submit" id="login-btn" class="btn-primary">Get OTP</button>
        </form>
        <p id="error-msg" class="text-danger mt-3 small"></p>
    </div>

    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/services/api.service.js"></script>
    <script src="../assets/js/utils/toast.js"></script>
    
    <script>
        // Simple Login Logic
        let isOtpSent = false;
        const form = document.getElementById('rider-login-form');
        const phoneInput = document.getElementById('phone');
        const otpInput = document.getElementById('otp');
        const btn = document.getElementById('login-btn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = "+91" + phoneInput.value.replace("+91", "").trim();

            if (!isOtpSent) {
                // Step 1: Send OTP
                try {
                    btn.innerText = "Sending...";
                    await ApiService.post('/notifications/send-otp/', { phone });
                    isOtpSent = true;
                    otpInput.style.display = 'block';
                    phoneInput.disabled = true;
                    btn.innerText = "Login";
                } catch (err) {
                    alert("Error sending OTP: " + err.message);
                    btn.innerText = "Get OTP";
                }
            } else {
                // Step 2: Verify & Login
                try {
                    btn.innerText = "Verifying...";
                    const res = await ApiService.post('/auth/register/customer/', { 
                        phone, otp: otpInput.value 
                    });

                    // Token Save karein
                    localStorage.setItem(APP_CONFIG.STORAGE_KEYS.TOKEN, res.access);
                    
                    // Check karein ki ye Rider hai ya nahi
                    try {
                        await ApiService.get('/riders/me/');
                        window.location.href = 'index.html'; // Go to Dashboard
                    } catch (roleErr) {
                        alert("Access Denied! This number is not registered as a Rider.");
                        localStorage.clear();
                        window.location.reload();
                    }

                } catch (err) {
                    alert("Login Failed: " + err.message);
                    btn.innerText = "Login";
                }
            }
        });
    </script>
</body>
</html>